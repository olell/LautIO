<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <link rel="icon" href="/static/png/logo_256.png">
    <link rel="apple-touch-icon" href="/static/png/logo_256.png">
    <title>Home  Â·  LautIO</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='/static/css/main.css'>
    <link rel='stylesheet' type='text/css' media='screen' href='/static/css/bootstrap.min.css'>
    <script src='/static/js/main.js'></script>
</head>
<body style="padding-top: 5rem">

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" style="padding: 0.5rem 1.5rem">
        <a class="navbar-brand ml-1" href="#">
            <img src="/static/svg/logo.svg" width=30 height=30 alt="LautIO Logo">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarSettingsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Settings
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarSettingsDropdown">
                        <li><a class="dropdown-item" href="/settings/wifi">WiFi</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/about">About</a>
                </li>
            </ul>
        </div>
    </nav>


    <main role="main" class="container">
        <h1>Overview</h1>
        <hr>
        <div class="row">
            <div class="col col-md-6">
                <h3 class="mb-3">Amplifier</h3>
                <div class="card">
                    <h5 class="card-header">Ch. A & B Amplifier
                        <button class="btn btn-primary float-end" data-bs-toggle="collapse" data-bs-target="#ampABCollapse" aria-controls="ampABCollapse" aria-expanded="true" aria-label="Toggle Amp AB Settings">
                            Show/Hide
                        </button><br class="mb-1">

                        <span class="badge rounded-pill bg-success" id="ampABRunningPill">Running</span>
                        <span class="badge rounded-pill bg-danger" id="ampABStandbyPill">Standby</span>
                        <span class="badge rounded-pill bg-dark ms-1" id="ampABMutePill">Muted</span>
                    </h5>
                    <div class="collapse show" id="ampABCollapse">
                        <div class="card-body">
                            <h5 class="card-title">Amplifier quick settings</h5>
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="ampABStandbySwitch" checked>
                                <label class="form-check-label" for="ampABStandbySwitchLabel">Standby</label>
                            </div>
                            <div class="form-check form-switch mb-5">
                                <input class="form-check-input" type="checkbox" id="ampABMuteSwitch" checked disabled>
                                <label class="form-check-label" for="ampABMuteSwitchLabel">Mute</label>
                            </div>
                            <span>
                                (Change gain via jumper on board)
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card mt-3">
                    <h5 class="card-header">Ch. C & D Amplifier
                        <button class="btn btn-primary float-end" data-bs-toggle="collapse" data-bs-target="#ampCDCollapse" aria-controls="ampCDCollapse" aria-expanded="true" aria-label="Toggle Amp AB Settings">
                            Show/Hide
                        </button><br class="mb-1">

                        <span class="badge rounded-pill bg-success" id="ampCDRunningPill">Running</span>
                        <span class="badge rounded-pill bg-danger" id="ampCDStandbyPill">Standby</span>
                        <span class="badge rounded-pill bg-dark ms-1" id="ampCDMutePill">Muted</span>
                    </h5>
                    <div class="collapse show" id="ampCDCollapse">
                        <div class="card-body">
                            <h5 class="card-title">Amplifier quick settings</h5>
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="ampCDStandbySwitch" checked>
                                <label class="form-check-label" for="ampCDStandbySwitchLabel">Standby</label>
                            </div>
                            <div class="form-check form-switch mb-5">
                                <input class="form-check-input" type="checkbox" id="ampCDMuteSwitch" checked disabled>
                                <label class="form-check-label" for="ampCDMuteSwitchLabel">Mute</label>
                            </div>
                            (Change gain via jumper on board)
                        </div>
                    </div>
                </div>
            </div>
            <div class="col col-md-6">
                <h3 class="mb-3">DSP Controls</h3>
                <div class="" id="dsp_controls">

                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <span class="text-muted float-end">
                <span class="con_dot disconnected" id="connection_dot"></span>
                <span id="connection_text"></span>
            </span>
        </div>
      </footer>
    
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/dsp.js"></script>

    <script>

        /* Amp Stuff */

        var amp_ab = {
            mute: true,
            standby: true
        };

        var amp_cd = {
            mute: true,
            standby: true
        };

        function set_mute_state(amp, state) {
            amp.mute = state;
            update_amp_pills();
        }

        function set_standby_state(amp, state) {
            amp.standby = state;
            update_amp_pills();
        }

        function update_amp_pills() {
            $("#ampABMutePill").toggle(amp_ab.mute);
            $("#ampCDMutePill").toggle(amp_cd.mute);

            $("#ampABStandbyPill").toggle(amp_ab.standby);
            $("#ampABRunningPill").toggle(!amp_ab.standby);

            $("#ampCDStandbyPill").toggle(amp_cd.standby);
            $("#ampCDRunningPill").toggle(!amp_cd.standby);
        }

        /* Amp AB Controls */

        $( "#ampABStandbySwitch" ).change(function () {
            set_standby_state(amp_ab, $("#ampABStandbySwitch").prop("checked"));
            $("#ampABMuteSwitch").prop("disabled", amp_ab.standby);
        });

        $( "#ampABMuteSwitch" ).change(function () {
            set_mute_state(amp_ab, $("#ampABMuteSwitch").prop("checked"));
            $("#ampABStandbySwitch").prop("disabled", !amp_ab.mute);
        });

        /* Amp CD Controls */

        $( "#ampCDStandbySwitch" ).change(function () {
            set_standby_state(amp_cd, $("#ampCDStandbySwitch").prop("checked"));
            $("#ampCDMuteSwitch").prop("disabled", amp_cd.standby);
        });

        $( "#ampCDMuteSwitch" ).change(function () {
            set_mute_state(amp_cd, $("#ampCDMuteSwitch").prop("checked"));
            $("#ampCDStandbySwitch").prop("disabled", !amp_cd.mute);
        });

        /* websocket stuff */
        var ws;
        var test_response_received = false;

        /* Common stuff */

        function on_websocket_message(recv) {
            var message = JSON.parse(recv.data);

            if (message.message == "test command received!") {
                // handle response to test command
                test_response_received = true;
            }

        }

        function update_connection_status() {
            ws.send(JSON.stringify({
                "command": "test"
            }));
            setTimeout(_display_connection_status, 100);
        }

        function _display_connection_status() {
            if (test_response_received) {
                test_response_received = false;
                $("#connection_dot").removeClass("disconnected");
                $("#connection_dot").addClass("connected");
                $("#connection_text").text("Connected to device!");
            }
            else {
                $("#connection_dot").removeClass("connected");
                $("#connection_dot").addClass("disconnected");
                $("#connection_text").text("Disconnected from device!");
            }
        }

        $( document ).ready(function () {
            update_amp_pills();
            create_dsp_controls($("#dsp_controls"));

            ws = new WebSocket("ws://" + location.hostname + "/ws");
            ws.onmessage = on_websocket_message;
            dsp_register_websocket(ws);

            setInterval(update_connection_status, 1000);
        });

        $( window ).on("beforeunload", function () {
            ws.close();
        })

    </script>

</body>
</html>